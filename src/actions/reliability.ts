'use server';

import {
  GoogleGenerativeAI,
  HarmCategory,
  HarmBlockThreshold,
} from '@google/generative-ai';
import type {
  Supplier,
  PredictFailureRiskFactorsOutput,
  AnalyzeChartDataOutput,
  AnalyzeChartDataInput,
  AssetData,
} from '@/lib/types';

// === CONFIRME: ESTE É O MODELO CORRETO (2025+) ===
const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY as string);

const model = genAI.getGenerativeModel({
  model: 'gemini-2.5-flash', // <--- MODELO VÁLIDO
  generationConfig: {
    temperature: 0.2,
    topP: 0.8,
    topK: 40,
    maxOutputTokens: 8192,
  },
  safetySettings: [
    { category: HarmCategory.HARM_CATEGORY_HARASSMENT, threshold: HarmBlockThreshold.BLOCK_NONE },
    { category: HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold: HarmBlockThreshold.BLOCK_NONE },
    { category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold: HarmBlockThreshold.BLOCK_NONE },
    { category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold: HarmBlockThreshold.BLOCK_NONE },
  ],
});

// DEBUG: Confirme no console se o modelo está certo
console.log('MODEL USED:', model.model); // Deve logar: gemini-2.5-flash

async function runAI<T>(prompt: string): Promise<T | { error: string }> {
  try {
    const result = await model.generateContent(prompt);
    
    if (
      !result.response ||
      !result.response.candidates ||
      result.response.candidates.length === 0
    ) {
      throw new Error('No content generated by AI.');
    }
    
    const responseText = result.response.text();
    if (!responseText) {
      throw new Error('AI returned an empty response.');
    }

    // Clean the response to ensure it's a valid JSON string
    const cleanedText = responseText.replace(/```json/g, '').replace(/```/g, '').trim();

    return JSON.parse(cleanedText) as T;

  } catch (error: any) {
    console.error('AI Error:', error.message);
    return { error: `AI generation failed. Details: ${error.message}` };
  }
}

export async function getRiskFactors(
  suppliers: Supplier[]
): Promise<PredictFailureRiskFactorsOutput | { error: string }> {
  if (suppliers.length === 0) {
    return {
      riskFactors: [],
      summary: 'Nenhum dado de equipamento disponível para analisar os fatores de risco.',
    };
  }
  const historicalData = suppliers
    .map(s => `Equipamento ${s.name} tempos de falha: ${s.failureTimes.join(', ')}`)
    .join('\n');

  const prompt = `Você é um engenheiro de confiabilidade especialista. Analise os seguintes dados históricos de falha para identificar os fatores de risco mais significativos que contribuem para as falhas.

Dados Históricos:
${historicalData}

Com base nestes dados, forneça um resumo técnico explicando o que os fatores de risco significam neste contexto e como o "percentual de importância" deve ser interpretado. Em seguida, liste os 3-5 principais fatores de risco classificados por importância. A importância deve ser um número entre 0 e 1, onde 1 indica o maior impacto no risco de falha. Se nenhum padrão claro emergir dos dados, retorne uma matriz vazia para "riskFactors".

Forneça a saída inteira em um único objeto JSON válido com a seguinte estrutura:
{
  "riskFactors": [ { "factor": "...", "importance": 0.0 } ],
  "summary": "..."
}
Não inclua nenhum texto ou formatação fora deste objeto JSON.`;

  return runAI<PredictFailureRiskFactorsOutput>(prompt);
}

export async function getChartAnalysis(
  input: AnalyzeChartDataInput
): Promise<AnalyzeChartDataOutput | { error: string }> {
  if (input.suppliers.length === 0) {
    return { error: 'Nenhum dado de equipamento para analisar.' };
  }

  const suppliersJson = JSON.stringify(input.suppliers.map(s => {
    const params: any = { name: s.name, distribution: s.distribution };
    if (s.distribution === 'Weibull') {
        params.beta = s.params.beta;
        params.eta = s.params.eta;
    } else if (s.distribution === 'Normal' || s.distribution === 'Lognormal') {
        params.mean = s.params.mean;
        params.stdDev = s.params.stdDev;
    } else if (s.distribution === 'Exponential') {
        params.lambda = s.params.lambda;
    }
    return params;
  }), null, 2);

  const prompt = `Você é um engenheiro de confiabilidade especialista. Sua tarefa é fornecer uma análise comparativa detalhada dos seguintes equipamentos com base em seus parâmetros de distribuição de probabilidade.

Dados dos Equipamentos:
${suppliersJson}

Analise os dados e gere uma explicação técnica detalhada para cada um dos quatro gráficos de confiabilidade a seguir. Para cada gráfico, compare os equipamentos e explique o que suas respectivas curvas significam, levando em consideração o tipo de distribuição de cada um. Use markdown para formatação, incluindo negrito para termos-chave e listas quando apropriado.

1.  **Curva de Confiabilidade R(t):** A probabilidade de um componente funcionar sem falha até o tempo t.
2.  **Probabilidade de Falha F(t):** A probabilidade de um componente falhar até o tempo t. Esta é a função de distribuição acumulada (FDA).
3.  **Densidade de Probabilidade f(t):** A probabilidade relativa de falha em um tempo específico t. Esta é a função de densidade de probabilidade (FDP).
4.  **Taxa de Falha λ(t) (Função de Risco):** A taxa instantânea de falha no tempo t, dado que o componente sobreviveu até t.

Forneça a saída inteira em um único objeto JSON válido com a seguinte estrutura:
{
  "reliability": { "title": "Curva de Confiabilidade - R(t)", "analysis": "..." },
  "failureProbability": { "title": "Probabilidade de Falha - F(t)", "analysis": "..." },
  "probabilityDensity": { "title": "Densidade de Probabilidade - f(t)", "analysis": "..." },
  "failureRate": { "title": "Taxa de Falha - λ(t)", "analysis": "..." }
}
Não inclua nenhum texto ou formatação fora deste objeto JSON.`;

  return runAI<AnalyzeChartDataOutput>(prompt);
}

export async function generateRcaReport(
  asset: AssetData,
  mtbf: number
): Promise<{ report: string } | { error: string }> {
  const assetDetails = `
- Nome: ${asset.name}
- Localização: ${asset.location}
- Criticidade: ${asset.criticality}
- Ciclo de Vida: ${asset.lifecycle}
- Saúde PdM: ${asset.pdmHealth}%
- Custo de Manutenção: ${asset.maintenanceCost}
- Custo de Downtime: ${asset.downtimeLoss}
- Tempos de Falha (horas): ${asset.failureTimes}
- MTBF (calculado): ${mtbf.toFixed(0)} horas
- MTTR (reportado): ${asset.mttr} horas
- RPN (Risco): ${asset.rpn}
- Severidade: ${asset.severity}
`;

  const prompt = `Você é um engenheiro de confiabilidade sênior, especialista em Análise de Causa Raiz (RCA). Sua tarefa é gerar um relatório de RCA conciso e acionável para o seguinte ativo.

Dados do Ativo:
${assetDetails}

O motor de decisão já recomendou a substituição/reforma deste ativo com base em seus indicadores críticos.

Seu relatório deve seguir estritamente a seguinte estrutura, usando Markdown para formatação:

### Relatório de Análise de Causa Raiz (RCA) - ${asset.name}

**1. Resumo Executivo:**
*   (Forneça um parágrafo conciso resumindo a situação crítica do ativo e a recomendação principal).

**2. Análise dos Indicadores de Falha:**
*   **Modo de Falha Predominante:** (Analise os tempos de falha. Eles são próximos? Distantes? Isso indica desgaste, falha aleatória ou mortalidade infantil? Relacione com o parâmetro Beta de Weibull, se aplicável, mesmo que não seja fornecido diretamente).
*   **Saúde Preditiva (PdM Health):** (Interprete o baixo valor de ${asset.pdmHealth}%. O que isso significa na prática?).
*   **Indicadores de Risco (RPN e Severidade):** (Explique o que o RPN de ${asset.rpn} e a Severidade de ${asset.severity} representam em termos de impacto operacional e de segurança).

**3. Análise de Impacto Financeiro:**
*   **Intensidade de Manutenção (Manut./GBV):** (Calcule e interprete a razão entre o Custo de Manutenção (${asset.maintenanceCost}) e o Valor do Ativo (GBV - ${asset.gbv})).
*   **Custo Total de Propriedade (TCO):** (Analise o impacto combinado dos custos de manutenção e perdas por downtime (${asset.downtimeLoss})).

**4. Análise da Curva da Banheira:**
*   (Com base nos tempos de falha e no ciclo de vida '${asset.lifecycle}', posicione o ativo na Curva da Banheira e explique o que essa fase significa para a estratégia de manutenção).

**5. Plano de Ação Recomendado:**
*   **Ação Imediata:** (Detalhe a recomendação de substituição ou reforma, justificando com os dados acima).
*   **Ações de Mitigação (curto prazo):** (Se a substituição não for imediata, o que pode ser feito para reduzir o risco?).
*   **Ações de Melhoria Contínua (longo prazo):** (Sugira melhorias no plano de manutenção, na estratégia de sobressalentes ou na monitoração para ativos futuros ou similares).

Forneça a saída inteira em um único objeto JSON válido com a seguinte estrutura:
{
  "report": "..."
}
Não inclua nenhum texto ou formatação fora deste objeto JSON.`;

  return runAI<{ report: string }>(prompt);
}
